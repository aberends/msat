<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>1.4. DNS configuration</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 2.8" /><meta name="package" content="" /></head><body class="draft "><div class="section" id="sect-msat-guide-DNS_configuration"><div class="titlepage"><div><div><h1 class="title" id="sect-msat-guide-DNS_configuration">1.4. DNS configuration</h1></div></div></div><div class="table" id="tabl-msat-guide-DNS_configuration-Time_needed"><h6>Table 1.7. Time needed</h6><div class="table-contents"><table summary="Time needed" border="1"><colgroup><col width="50%" style="text-align: left" class="c1" /><col width="50%" style="text-align: left" class="c2" /></colgroup><thead valign="top"><tr><th style="text-align: left" valign="top">
						action
					</th><th style="text-align: left" valign="top">
						time
					</th></tr></thead><tbody valign="top"><tr><td style="text-align: left" valign="top">
						DNS configuration
					</td><td style="text-align: left" valign="top">
						10 minutes
					</td></tr></tbody></table></div></div><div class="para">
		First of all, to be able to configure DNS, we need the software, if not yet available: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>yum install bind-chroot</code></strong>
.. output skipped ..
</pre>

	</div><div class="para">
		We want to set up the Spacewalk server as DNS server. In order for Spacewalk to function correctly, one needs DNS. During registration of provisioned hosts, Spacewalk does a reverse DNS query for the hostname of the registering host. In this section we describe how we configure DNS in the <span class="emphasis"><em>dmsat1</em></span> environment.
	</div><div class="para">
		We want DNS to behave in the following way: 
		<div class="itemizedlist"><ul><li class="listitem"><div class="para">
					All DNS queries outside our domain, <code class="systemitem">dmsat1.org</code>, must go to the upstream DNS server, <code class="systemitem">192.168.1.1</code>. Consequently, we are a forwarding DNS server. The result queries must be cached.
				</div></li><li class="listitem"><div class="para">
					We want logging.
				</div></li><li class="listitem"><div class="para">
					The Spacewalk server is the name authority for <code class="systemitem">dmsat1.org</code>.
				</div></li></ul></div>

	</div><div class="para">
		Since we also want to keep track of the virtual MAC addresses, we use the main DNS zone file for keeping track of this administration.
	</div><div class="para">
		We just show all the DNS files here and explain afterwards how the directory structure looks: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>cat /var/named/chroot/etc/named.conf</code></strong>
// /etc/named.conf

options {
  /*
   * Check names following RFC 952 and RFC 1123. The
   * master has strict checking. Incorrect names make
   * the nameserver fail. The slaves receive the names
   * from the master, hence those names are not
   * checked.
   */
  check-names master fail;
  check-names slave ignore;
  listen-on port 53 {
    192.168.5.11;
    127.0.0.1;
  };
  //listen-on-v6 port 53 { ::1; };
  directory   "/var/named";
  dump-file   "/var/named/data/cache_dump.db";
  statistics-file "/var/named/data/named_stats.txt";
  memstatistics-file "/var/named/data/named_mem_stats.txt";
  /*
   * To start out, we want all hosts to be able to
   * query this nameserver.
   */
  //allow-query     { localhost; };
  allow-query     { any; };
  //allow-query-on  { any; };
  //allow-query-on  { 192.168.1.16; 127.0.0.1; };
  recursion yes;
};

/*
 * Allowable log levels:
 * critical
 * error
 * warning
 * notice
 * info
 * debug [level]
 * dynamic
 */

/*
 * Allowable log categories:
 * client
 * config
 * database
 * default (all categories except queries)
 * delegation-only
 * dispatch
 * dnssec
 * general
 * lame-servers
 * network
 * notify
 * queries
 * resolver
 * security
 * unmatched
 * update
 * update-security
 * xfer-in
 * xfer-out
 */

logging {
  channel default_debug {
    file "/var/log/named.log" versions 5 size 5m;
    severity dynamic;
    print-time yes;
    print-severity yes;
    print-category yes;
  };

  category default { default_debug; };
  category queries { default_debug; };
};

/*
 * The '.' represents all other zones. We depend on the
 * upstream DNS server, 192.168.1.1, so all requests go
 * there. The answers are cached.
 */
zone "." IN {
  type forward;
  forward first;
  forwarders { 192.168.1.1; };
};

/*
 * Instead of including named.rfc1912.zones, we define our
 * localhost zones ourselves below.
 */
//include "/etc/named.rfc1912.zones";

zone "localhost.localdomain." IN {
  type master;
  file "named.localhost";
  allow-update { none; };
};

zone "localhost." IN {
  type master;
  file "named.localhost";
  allow-update { none; };
};

zone "127.in-addr.arpa." IN {
  type master;
  file "127.in-addr.arpa";
  allow-update { none; };
};

zone "dmsat1.org." IN {
  type master;
  file "dmsat1.org.zone";
  notify yes;
  allow-transfer { any; };
};

zone "5.168.192.in-addr.arpa." IN {
  type master;
  file "192.168.5.in-addr.arpa";
  notify yes;
  allow-transfer { any; };
};
</pre>
		 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>cat /var/named/chroot/var/named/127.in-addr.arpa</code></strong>
$TTL    86400
@       IN SOA d19sw1.dmsat1.org. root.d19sw1.dmsat1.org. (
        2012012300      ; serial, format: YYYYMMDDNN, where
      ; NN is the daily sequence number.
      ; After editing this file, always
      ; update this serial number to give
      ; slaves a chance to keep
      ; synchronized.
        3H              ; refresh. The refresh interval
      ; tells a slave for the zone how
      ; often to check that the data for
      ; this zone is up to date.
        15M             ; retry. If a slave fails to connect
      ; to the master, it will retry in
      ; this amount of time. So here it is
      ; 15 minutes.
        1W              ; expiry. If a slave did not contact
      ; the server for this amount of
      ; time, its records become useless,
      ; i.e. are expired.
        1D )            ; minimum. TTL for negative
      ; responses of this nameserver for
      ; authoriative requests. So the
      ; client must not ask for the same
      ; RR (Resource Record) it got a
      ; negative response for in the
      ; specified amount of time.

;
; @ is implied!
;
        IN NS   d19sw1.dmsat1.org.

;
; 127.0.0.0/8
;
; Satellite.
1.0.0   IN  PTR localhost.localdomain.
</pre>
		 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>cat /var/named/chroot/var/named/192.168.5.in-addr.arpa</code></strong>
$TTL    86400
@       IN SOA d19sw1.dmsat1.org. root.d19sw1.dmsat1.org. (
        2012012300      ; serial, format: YYYYMMDDNN, where
      ; NN is the daily sequence number.
      ; After editing this file, always
      ; update this serial number to give
      ; slaves a chance to keep
      ; synchronized.
        3H              ; refresh. The refresh interval
      ; tells a slave for the zone how
      ; often to check that the data for
      ; this zone is up to date.
        15M             ; retry. If a slave fails to connect
      ; to the master, it will retry in
      ; this amount of time. So here it is
      ; 15 minutes.
        1W              ; expiry. If a slave did not contact
      ; the server for this amount of
      ; time, its records become useless,
      ; i.e. are expired.
        1D )            ; minimum. TTL for negative
      ; responses of this nameserver for
      ; authoriative requests. So the
      ; client must not ask for the same
      ; RR (Resource Record) it got a
      ; negative response for in the
      ; specified amount of time.

;
; @ (short for domain name) is implied!
;
        IN NS   d19sw1.dmsat1.org.

;
; 192.168.5.0/24
;

; Development Spacewalk server.
10  IN  PTR d19sw0.dmsat1.org.
11  IN  PTR d19sw1.dmsat1.org.
12  IN  PTR d19sw2.dmsat1.org.
100 IN  PTR dmm01.dmsat1.org.
</pre>
		 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>cat /var/named/chroot/var/named/dmsat1.org.zone</code></strong>
$TTL    86400
@       IN SOA d19sw1.dmsat1.org. root.d19sw1.dmsat1.org. (
        2012012300      ; serial, format: YYYYMMDDNN, where
      ; NN is the daily sequence number.
      ; After editing this file, always
      ; update this serial number to give
      ; slaves a chance to keep
      ; synchronized.
        3H              ; refresh. The refresh interval
      ; tells a slave for the zone how
      ; often to check that the data for
      ; this zone is up to date.
        15M             ; retry. If a slave fails to connect
      ; to the master, it will retry in
      ; this amount of time. So here it is
      ; 15 minutes.
        1W              ; expiry. If a slave did not contact
      ; the server for this amount of
      ; time, its records become useless,
      ; i.e. are expired.
        1D )            ; minimum. TTL for negative
      ; responses of this nameserver for
      ; authoriative requests. So the
      ; client must not ask for the same
      ; RR (Resource Record) it got a
      ; negative response for in the
      ; specified amount of time.

;
; @ (short for domain name) is implied!
;
        IN NS   d19sw1.dmsat1.org.

;
; 192.168.5.0/24
;

;network   IN      A       192.168.5.0
;gateway   IN      A       192.168.5.1
; MAC_ETH0=52:54:00:a8:05:0a
d19sw0     IN      A       192.168.5.10
; MAC_ETH0=52:54:00:a8:05:0b
d19sw1     IN      A       192.168.5.11
; MAC_ETH0=52:54:00:a8:05:0c
d19sw2     IN      A       192.168.5.12
; MAC_ETH0=52:54:00:a8:05:64
dmm01      IN      A       192.168.5.100
;broadcast IN      A       192.168.5.255
</pre>
		 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>cat /var/named/chroot/var/named/named.localhost</code></strong>
$TTL    86400
@       IN SOA @ rname.invalid. (
        2012012300      ; serial, format: YYYYMMDDNN, where
      ; NN is the daily sequence number.
      ; After editing this file, always
      ; update this serial number to give
      ; slaves a chance to keep
      ; synchronized.
        3H              ; refresh. The refresh interval
      ; tells a slave for the zone how
      ; often to check that the data for
      ; this zone is up to date.
        15M             ; retry. If a slave fails to connect
      ; to the master, it will retry in
      ; this amount of time. So here it is
      ; 15 minutes.
        1W              ; expiry. If a slave did not contact
      ; the server for this amount of
      ; time, its records become useless,
      ; i.e. are expired.
        1D )            ; minimum. TTL for negative
      ; responses of this nameserver for
      ; authoriative requests. So the
      ; client must not ask for the same
      ; RR (Resource Record) it got a
      ; negative response for in the
      ; specified amount of time.

;
; @ is implied!
;
        NS  @
    A   127.0.0.1
    AAAA    ::1
</pre>

	</div><div class="para">
		In a directory tree, the structure looks like this: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>tree --charset=ASCII -F /var/named/chroot</code></strong>
/var/named/chroot
|-- dev/
|   |-- null
|   |-- random
|   `-- zero
|-- etc/
|   |-- localtime
|   |-- named/
|   |-- <span class="bold bold"><strong>named.conf</strong></span>
|   |-- named.iscdlv.key
|   |-- named.rfc1912.zones
|   |-- named.root.key
|   |-- pki/
|   |   `-- dnssec-keys/
|   `-- rndc.key
|-- usr/
|   `-- lib64/
|       `-- bind/
`-- var/
    |-- log/
    |   `-- named.log
    |-- named/
    |   |-- <span class="bold bold"><strong>127.in-addr.arpa</strong></span>
    |   |-- <span class="bold bold"><strong>192.168.5.in-addr.arpa</strong></span>
    |   |-- <span class="bold bold"><strong>dmsat1.org.zone</strong></span>
    |   |-- named.ca
    |   |-- named.empty
    |   |-- <span class="bold bold"><strong>named.localhost</strong></span>
    |   `-- named.loopback
    |-- run/
    |   `-- named/
    |       |-- named.pid
    |       `-- session.key
    `-- tmp/
</pre>

	</div><div class="para">
		Reconfigure the <code class="filename">/etc/resolv.conf</code> so that the <code class="systemitem">d19sw1.dmsat1.org</code> also resolvs to its own DNS: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>sed -i 's/^DNS1=.*$/DNS1=192.168.5.11/' /etc/sysconfig/network-scripts/ifcfg-eth0</code></strong>
.. inotify informs NetworkManager ..
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>cat /etc/resolv.conf</code></strong>
# Generated by NetworkManager
search dmsat1.org
nameserver 192.168.5.11
</pre>
		 If the change is not picked up, do: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>systemctl restart NetworkManager.service</code></strong></pre>

	</div><div class="para">
		Make sure to enable the service and start it: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>systemctl enable named-chroot.service</code></strong>
ln -s '/usr/lib/systemd/system/named-chroot.service' '/etc/systemd/system/multi-user.target.wants/named-chroot.service'
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>systemctl start named-chroot.service</code></strong></pre>

	</div><div class="para">
		Do some tests: 
<pre class="screen">
<code class="prompt">d19sw1#</code> <strong class="userinput"><code>for i in d19sw0.dmsat1.org d19sw1.dmsat1.org d19sw2.dmsat1.org dmm01.dmsat1.org d19sw0 d19sw1 d19sw2 dmm01 192.168.5.10 192.168.5.11 192.168.5.12 192.168.5.100; do host $i; done</code></strong>
d19sw0.dmsat1.org has address 192.168.5.10
d19sw1.dmsat1.org has address 192.168.5.11
d19sw2.dmsat1.org has address 192.168.5.12
dmm01.dmsat1.org has address 192.168.5.100
d19sw0.dmsat1.org has address 192.168.5.10
d19sw1.dmsat1.org has address 192.168.5.11
d19sw2.dmsat1.org has address 192.168.5.12
dmm01.dmsat1.org has address 192.168.5.100
10.5.168.192.in-addr.arpa domain name pointer d19sw0.dmsat1.org.
11.5.168.192.in-addr.arpa domain name pointer d19sw1.dmsat1.org.
12.5.168.192.in-addr.arpa domain name pointer d19sw2.dmsat1.org.
100.5.168.192.in-addr.arpa domain name pointer dmm01.dmsat1.org.
</pre>

	</div></div></body></html>
