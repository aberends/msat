<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "msat-guide.ent">
%BOOK_ENTITIES;
]>
<section id="software-ds_install">
  <title>Directory server installation</title>
  <table id="msat-guide-software-ds_install-time">
    <title>Time needed</title>
    <tgroup align="left" cols="2" colsep="1" rowsep="1">
      <colspec colname="c1" colnum="1" colwidth="1*"></colspec>
      <colspec colname="c2" colnum="2" colwidth="1*"></colspec>
      <thead valign="top">
        <row>
          <entry>action</entry>
          <entry>time</entry>
        </row>
      </thead>
      <tbody valign="top">
        <row>
          <entry>Config channel</entry>
          <entry>5 minutes</entry>
        </row>
        <row>
          <entry>Activation key</entry>
          <entry>5 minutes</entry>
        </row>
        <row>
          <entry>Kickstart profile</entry>
          <entry>20 minutes</entry>
        </row>
        <row>
          <entry>Cobbler</entry>
          <entry>5 minutes</entry>
        </row>
        <row>
          <entry>Test installation</entry>
          <entry>15 minutes</entry>
        </row>
      </tbody>
    </tgroup>
  </table>
  <para>
    To install the directory server, we need the following
    items: 
    <itemizedlist>
      <listitem>
        <para>
          A configuration channel with configuration files
          to specify how we want the directory server to be
          configured.
        </para>
      </listitem>
      <listitem>
        <para>
          An activation key with at least one RPM and a link
          to the configuration channel.
        </para>
      </listitem>
      <listitem>
        <para>
          A kickstart profile with a link to the activation
          key and 1 post install script.
        </para>
      </listitem>
      <listitem>
        <para>
          A Cobbler system and the Cobbler boot ISO.
        </para>
      </listitem>
      <listitem>
        <para>
          The environment on the host to create a KVM virtual machine.
        </para>
      </listitem>
    </itemizedlist>
  </para>

  <section id="software-ds-cc">
    <title>Config Channel</title>
     <para>
     </para>
  </section>
  
  <section id="software-ds-ak">
    <title>Activation Key</title>
    <para>
    </para>
  </section>
  
  <section id="software-ds-kp">
    <title>Kickstart Profile</title>
    <para>
    </para>
  </section>
  
  <section id="software-ds-cob">
    <title>Cobbler</title>
    <para>
      Since we want to start our bare metal provisioning
      with a boot ISO, we need to create a system in
      Cobbler. This task can be accomplished by using a
      script. We present it here: 
      <screen>
&sw1p; <userinput>cat /root/cobbler-ds1.sh</userinput>
#!/bin/bash
#
# SCRIPT
#   cobbler-ds1.sh
# DESCRIPTION
#   This script should be run on the Spacewalk server:
#   # ./cobbler-ds1.sh
#
#   IP details
#
#   Host       Prod            Cluster        ILO
#   ds1        192.168.5.100   -              -
#
#   Subnets:
#   192.168.5.0/24  gw: 192.168.5.1
#
#   DNS servers:
#   * 192.168.5.11 (d19sw1.dmsat1.org)
#
# ARGUMENTS
#   None.
# RETURN
#   Value from cobbler command. See cobbler man page.
# DEPENDENCIES
#   The profile should not yet exist in cobbler. If it does,
#   remove it with:
#   sudo cobbler system remove \
#     --name=SpacewalkDefaultOrganization_kvm_ds1
#   Adding an existing profile results in a clear warning
#   from cobbler. No harm is done.
# FAILURE
# AUTHORS
#   Date strings made with 'date +"\%Y-\%m-\%d \%H:\%M"'.
#   Allard Berends (AB), 2013-06-07 00:30
# HISTORY
# LICENSE
#   Copyright (C) 2013 Allard Berends
# 
#   cobbler-ds1.sh is free software; you can
#   redistribute it and/or modify it under the terms of the
#   GNU General Public License as published by the Free
#   Software Foundation; either version 3 of the License, or
#   (at your option) any later version.
#
#   cobbler-ds1.sh is distributed in the hope
#   that it will be useful, but WITHOUT ANY WARRANTY;
#   without even the implied warranty of MERCHANTABILITY or
#   FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
#   Public License for more details.
#
#   You should have received a copy of the GNU General
#   Public License along with this program; if not, write to
#   the Free Software Foundation, Inc., 59 Temple Place -
#   Suite 330, Boston, MA 02111-1307, USA.
# DESIGN
#

COBBLER="sudo cobbler"
# AB: non base Spacewalk organizations have orgnum != 1
#ORGNUM=$(msat_ls_org.py)
ORGNUM=1

########## PARAMETERS TO EDIT ##########
NAME="ds1"
OWNERS="example"
MACH="kvm"
PROFILE="ds-kvm-5u8-1_0"
ORG="SpacewalkDefaultOrganization"
COMMENT="empty"
GATEWAY=192.168.5.1
NAMESERVERS="192.168.5.11"
NAMESERVERS_SEARCH="dmsat1.org"
HOSTNAME=${NAME}.${NAMESERVERS_SEARCH}
PROD_IP=192.168.5.14
PROD_SUBNET=255.255.255.0
PROD_DNS_NAME=${HOSTNAME}
MAC_ETH0=52:54:00:a8:05:0e

########## START SCRIPT ##########
$COBBLER system add \
  --name=${ORG}_${MACH}_${NAME} \
  --owners=${OWNERS} \
  --profile=${PROFILE}:${ORGNUM}:${ORG} \
  --kopts="ksdevice=${MAC_ETH0} ip=${PROD_IP} netmask=${PROD_SUBNET}" \
  --netboot-enabled=0 \
  --comment=${COMMENT} \
  --power-type=ipmitool \
  --hostname=${HOSTNAME} \
  --gateway=${GATEWAY} \
  --name-servers="$NAMESERVERS" \
  --name-servers-search=$NAMESERVERS_SEARCH \
  --redhat-management-key='&lt;&lt;inherit&gt;&gt;' \
  --redhat-management-server='&lt;&lt;inherit&gt;&gt;'
  #--uid=UID
  #--image=IMAGE
  #--kopts-post=KOPTS_POST
  #--ksmeta=KSMETA
  #--kickstart=KICKSTART
  #--depth=DEPTH
  #--server=SERVER
  #--virt-path=VIRT_PATH
  #--virt-type=VIRT_TYPE
  #--virt-cpus=VIRT_CPUS
  #--virt-file-size=VIRT_FILE_SIZE
  #--virt-ram=VIRT_RAM
  #--virt-auto-boot=VIRT_AUTO_BOOT
  #--ctime=CTIME
  #--mtime=MTIME
  #--power-address=POWER_ADDRESS
  #--power-user=POWER_USER
  #--power-pass=POWER_PASS
  #--power-id=POWER_ID
  #--ipv6-default-device=IPV6_DEFAULT_DEVICE
  #--ipv6-autoconfiguration=IPV6_AUTOCONFIGURATION
  #--mgmt-classes=MGMT_CLASSES
  #--template-files=TEMPLATE_FILES
  #--template-remote-kickstarts=TEMPLATE_REMOTE_KICKSTARTS
  #--clobber
  #--template-files=TEMPLATE_FILES
  #--in-place

/usr/bin/cobbler system edit \
  --name=${ORG}_${MACH}_${NAME} \
  --mac-address=${MAC_ETH0} \
  --ip-address=${PROD_IP} \
  --static=1 \
  --subnet=${PROD_SUBNET} \
  --dns-name=${PROD_DNS_NAME} \
  --interface=eth0
  #--mtu=MTU
  #--dhcp-tag=DHCP_TAG
  #--static-routes=STATIC_ROUTES
  #--virt-bridge=VIRT_BRIDGE
  #--ipv6-address=IPV6_ADDRESS
  #--ipv6-secondaries=IPV6_SECONDARIES
  #--ipv6-mtu=IPV6_MTU
  #--ipv6-static-routes=IPV6_STATIC_ROUTES
  #--ipv6-default-gateway=IPV6_DEFAULT_GATEWAY
      </screen>
    </para>
    <para>
      We run the above script and verify that the system is
      known in Cobbler: 
      <screen>
&sw1p; <userinput>chmod u+x cobbler-ds1.sh</userinput>
&sw1p; <userinput>./cobbler-ds1.sh</userinput>
&sw1p; <userinput>sudo cobbler system list | grep ds1</userinput>
   SpacewalkDefaultOrganization_kvm_ds1
      </screen>
    </para>
    <para>
      We create the Cobbler boot ISO with: 
      <screen>
&sw1p; <userinput>sudo cobbler buildiso --iso=/var/www/cobbler/pub/example/centos5u8-ds-kvm.iso --profiles="" --systems="SpacewalkDefaultOrganization_kvm_ds1" --tempdir=/tmp</userinput>
task started: 2013-06-07_000320_buildiso
task started (id=Build Iso, time=Fri Jun  7 00:03:20 2013)
using/creating buildisodir: /tmp/buildiso
building tree for isolinux
copying miscellaneous files
copying kernels and initrds for profiles
copying kernels and initrds for systems
generating a isolinux.cfg
generating profile list
generating system list
 - ksdevice 52:54:00:a8:05:0e set for system SpacewalkDefaultOrganization_kvm_ds1
append line length is greater than 254 chars: (272 chars)
done writing config
running: mkisofs -o /var/www/cobbler/pub/example/centos5u8-ds-kvm.iso -r -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -V Cobbler\ Install -R -J -T /tmp/buildiso
received on stdout: 
received on stderr: I: -input-charset not specified, using utf-8 (detected in locale settings)
Size of boot image is 4 sectors -&gt; No emulation
 68.62% done, estimate finish Fri Jun  7 00:03:21 2013
Total translation table size: 4029
Total rockridge attributes bytes: 1320
Total directory bytes: 4096
Path table size(bytes): 40
Max brk space used 1c000
7301 extents written (14 MB)

ISO build complete
You may wish to delete: /tmp/buildiso
The output file is: /var/www/cobbler/pub/example/centos5u8-ds-kvm.iso
*** TASK COMPLETE ***
&sw1p; <userinput>ls -lh /var/www/cobbler/pub/example/centos5u8-ds-kvm.iso</userinput>
-rw-r--r--. 1 root root 15M Jun  7 00:03 /var/www/cobbler/pub/example/centos5u8-ds-kvm.iso
&sw1p; <userinput>scp /var/www/cobbler/pub/example/centos5u8-ds-kvm.iso root@192.168.5.1:/tmp</userinput>
      </screen>
    </para>
  </section>
  
  <section id="software-ds-kvm">
    <title>KVM installation</title>
    <para>
      On the host machine we need to create storage space for our test machine: 
      <screen>
&srvprompt; <userinput>pvs</userinput>
  PV         VG        Fmt  Attr PSize   PFree
  /dev/sda3  vg_server lvm2 a--  931.00g      0
  /dev/sdb   b         lvm2 a--  931.51g 638.54g
  /dev/sdc   c         lvm2 a--  931.51g 931.51g
  /dev/sdd   d         lvm2 a--  931.51g 931.51g
  /dev/sde   e         lvm2 a--  931.51g 926.63g
  /dev/sdf   f         lvm2 a--  931.51g 931.51g

&srvprompt; <userinput>pvs -o +vg_extent_size /dev/sde</userinput>
  PV         VG   Fmt  Attr PSize   PFree   Ext
  /dev/sde   e    lvm2 a--  931.51g 931.51g 4.00m

&srvprompt; <userinput>lvcreate -n ds1 -l $((25 * 10 * 5)) e</userinput>
  Logical volume "ds1" created

      </screen>
    </para>
    <para>
      Explanation of the parameters in the
      <command>virt-install</command> command: 
      <itemizedlist>
        <listitem>
          <para>
            ds1, ds (directory server), 1 (number 1).
          </para>
        </listitem>
        <listitem>
          <para>
            mac=52:54:00:a8:05:0e, 192.168.5.14 -&gt;
            00:a8:05:0e, the 52:54:00 is obligatory by
            libvirt definition.
          </para>
        </listitem>
      </itemizedlist>
      To make it easy to verify the
      <command>virt-install</command> options in the
      <emphasis>virt-install man page</emphasis>, we specify
      them in the same order as they appear in the man page.
    </para>
    <para>
      The installation is started with: 
      <screen>
&srvprompt; <userinput>virt-install \</userinput>
  <userinput>--connect qemu:///system \</userinput>
  <userinput>--name=ds1 \</userinput>
  <userinput>--ram=512 \</userinput>
  <userinput>--arch=x86_64 \</userinput>
  <userinput>--description="Directory Server 1" \</userinput>
  <userinput>--cdrom /tmp/centos5u8-ds-kvm.iso \</userinput>
  <userinput>--os-type=linux \</userinput>
  <userinput>--os-variant=rhel5.4 \</userinput>
  <userinput>--disk path=/dev/e/ds1,device=disk,bus=scsi \</userinput>
  <userinput>--network=network=dmsat1,mac=52:54:00:a8:05:0e \</userinput>
  <userinput>--graphics vnc \</userinput>
  <userinput>--hvm \</userinput>
  <userinput>--autostart</userinput>
.. output skipped, about 10 minutes ..
      </screen>
      Select <emphasis
      role="bold">SpacewalkDefaultOrganization_kvm_ds1</emphasis>
      and press <keycap function="enter">Enter</keycap>.
    </para>
    <para>
      To check on the installed system if everything is
      working fine, one does: 
      <screen>
&t1p; rhncfg-client list
Using server name d19sw1.dmsat1.org
DoFoS   Config Channel   File
F           test01     /etc/motd
&t1p; yum repolist
Loaded plugins: fastestmirror, rhnplugin, security
This system is receiving updates from RHN Classic or RHN Satellite.
Loading mirror speeds from cached hostfile
repo id                              repo name                            status
centos-x86_64-server-5               centos-x86_64-server-5               3,602
con-tools-centos-x86_64-server-5     con-tools-centos-x86_64-server-5        15
repolist: 3,617
      </screen>
    </para>
  </section>
</section>


